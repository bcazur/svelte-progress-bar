{{#if width}}
<div class="svelte-progress-bar" style="width: {{widthPercent}}%">
	<div class="svelte-progress-bar-leader"></div>
</div>
{{/if}}

<script>
const defaults = {
	minimum: 0.08,
	maximum: 0.994,
	settleTime: 700,
	intervalTime: 800
}
const stepSizes = [ 0, 0, 0.005, 0.01, 0.02 ]

function getIncrement(number) {
	if (number >= 0 && number < 0.2) return 0.1
	else if (number >= 0.2 && number < 0.5) return 0.04
	else if (number >= 0.5 && number < 0.8) return 0.02
	else if (number >= 0.8 && number < 0.99) return 0.005
	return 0
}

let updater

export default {
	methods: {
		start() {
			this.reset()
			this.continue()
		},
		reset() {
			const startingWidth = this.get('minimum') || defaults.minimum
			this.set({ width: startingWidth })
		},
		continue() {
			const maximumWidth = this.get('maximum') || defaults.maximum
			const intervalTime = this.get('intervalTime') || defaults.intervalTime

			this.stop() // prevent multiple intervals by clearing before making
			updater = setInterval(() => {
				let value = this.get('width')

				const randomStep = stepSizes[Math.floor(Math.random() * stepSizes.length)]
				const step = getIncrement(value) + randomStep
				if (value < maximumWidth) {
					value = value + step
				}
				if (value > maximumWidth) {
					value = maximumWidth
					this.stop()
				}
				this.set({ width: value })
			}, intervalTime)
		},
		stop() {
			if (updater) {
				clearInterval(updater)
			}
		},
		complete() {
			clearInterval(updater)
			this.set({ width: 1 })
			const settleTime = this.get('settleTime') || defaults.settleTime
			setTimeout(() => {
				this.set({ width: 0 })
			}, settleTime)
		}
	},
	computed: {
		widthPercent(width) {
			return width * 100
		}
	}
}
</script>

<style>
.svelte-progress-bar {
	position: absolute;
	top: 0;
	left: 0;
	height: 2px;
	z-index: 1;
	background-color: red;
	transition: width 0.16s ease-in-out;
}
.svelte-progress-bar-leader {
	position: absolute;
	top: 0;
	right: 0;
	height: 2px;
	width: 100px;
	z-index: 2;
	background-color: red;
	transform: rotate(2.5deg) translate(0px, -4px);
	box-shadow: 0 0 8px red, 0 0 8px red;
}
</style>
